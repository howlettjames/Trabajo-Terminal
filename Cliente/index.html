<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor App</title>
</head>
<body>
    <button id="requestbutton">Request Image</button>
    <br>
    <img src="" id="sobelimage" alt="Sobel Image" >
    
<script>   
    //document.getElementById("requestbutton").addEventListener('click', requestImage);
    setInterval(requestImage, 2000);

    const base64abc = [
    "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M",
    "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z",
    "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m",
    "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z",
    "0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "+", "/"
    ];

    function bytesToBase64(bytes) {
        let result = '', i, l = bytes.length;
        for (i = 2; i < l; i += 3) {
            result += base64abc[bytes[i - 2] >> 2];
            result += base64abc[((bytes[i - 2] & 0x03) << 4) | (bytes[i - 1] >> 4)];
            result += base64abc[((bytes[i - 1] & 0x0F) << 2) | (bytes[i] >> 6)];
            result += base64abc[bytes[i] & 0x3F];
        }
        if (i === l + 1) { // 1 octet yet to write
            result += base64abc[bytes[i - 2] >> 2];
            result += base64abc[(bytes[i - 2] & 0x03) << 4];
            result += "==";
        }
        if (i === l) { // 2 octets yet to write
            result += base64abc[bytes[i - 2] >> 2];
            result += base64abc[((bytes[i - 2] & 0x03) << 4) | (bytes[i - 1] >> 4)];
            result += base64abc[(bytes[i - 1] & 0x0F) << 2];
            result += "=";
        }
        return result;
    }

    function requestImage() 
    {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', 'http://localhost:8000/images/sobel', true);
        xhr.responseType = "arraybuffer";
        
        xhr.onload = function()
        {
            if(this.status == 200)
            {
                console.log("OK");
                let img_bytes = new Uint8Array(this.response);
                console.log("OK1");
                //let decoder = new TextDecoder();
                let img_base64 = bytesToBase64(img_bytes);
                console.log("OK2");
                // console.log(image_base64);
                document.getElementById("sobelimage").src = "data:image/bmp;base64," + img_base64;
                console.log(document.getElementById("sobelimage"));
            }
        }

        xhr.addEventListener("progress", function(event) {

            if(event.lengthComputable) {

            console.log("loaded so far: " + event.loaded + " of " + event.total);

            }

        });

        xhr.onerror = function()
        {
            console.log("Request Error...");
        }

        xhr.send();
    }
</script>
</body>
</html>